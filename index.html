
<!DOCTYPE html>
<html lang="es">
<head>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180.png">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167.png">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152.png">
<link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon-120.png">
<link rel='icon' type='image/png' href='favicon.png'>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SAME – ECUES</title>
<meta name="theme-color" content="#065f46">
<style>
  :root { --gap: 12px; --pad: 14px; --radius: 14px; --font: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: var(--font); background:#0f172a; color:#e5e7eb; }
  header { position: sticky; top: 0; z-index: 10; padding: var(--pad); background: #064e3b; border-bottom: 1px solid #065f46; }
  h1 { font-size: 1.15rem; margin: 0 0 6px 0; font-weight: 700; }
  .total { display: flex; align-items: center; gap: var(--gap); }
  .big-number { font-variant-numeric: tabular-nums; font-size: 2.6rem; font-weight: 800; letter-spacing: .5px; }
  .row { display:flex; align-items:center; gap:8px; }
  .btn { touch-action: manipulation; user-select: none; border: none; border-radius: 12px; padding: 12px 14px; font-size: 1.15rem; background:#065f46; color:#fff; }
  .btn:active { transform: scale(0.98); }
  .btn.small { padding: 8px 10px; font-size: 0.98rem; border-radius: 10px; }
  .btn.primary { background:#059669; }
  .btn.warn { background:#dc2626; }
  main { padding: var(--pad); display: grid; gap: var(--gap); }
  section { background:#111827; border:1px solid #1f2937; border-radius: var(--radius); padding: var(--pad); }
  section h2 { margin:0 0 10px 0; font-size:1.05rem; font-weight:700; letter-spacing:.2px; }
  .counter { display:flex; justify-content: space-between; align-items:center; padding:10px; background:#0b1221; border-radius:12px; border:1px solid #1e293b; }
  .label { font-size:1rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .value { font-variant-numeric: tabular-nums; font-size:1.6rem; min-width:3ch; text-align:right; }
  .controls { display:flex; gap:8px; }
  .footer { display:flex; gap:8px; flex-wrap: wrap; }
  .muted { color:#9ca3af; font-size:.9rem; }
  .grid-2 { display:grid; grid-template-columns: 1fr 1fr; gap: var(--gap); }
  .flash-red { animation: flashRed 0.4s ease; }
  @keyframes flashRed { 0% { background:#ff0000; } 100% { background:transparent; } }
  .sd-disabled .btn { opacity:.5; pointer-events: none; }
</style>
</head>
<body>
<header>
<div style='text-align:center; margin-top:10px;'>
<img src='icon-192.png' alt='Logo ECUES' style='width:100px; height:auto;'>
</div>
  <div class="row" style="justify-content: space-between;">
    <div>
      <h1>SAME – ECUES</h1>
      <div class="muted">Funciona offline • Guarda en este dispositivo</div>
    </div>
    <div class="row"><button class="btn small warn" id="btnReset">Reset</button>
    </div>
  </div>
  <div class="muted" style="margin-top:8px;">
    Sexo: <span id="restanteSexo">0</span> sin clasificar • 
    Edad: <span id="restanteEdad">0</span> sin clasificar
  </div>
  <div class="total" style="margin-top:10px; justify-content: space-between;">
    <div class="row" style="gap:10px;">
      <span>Hasta ahora</span>
      <span class="big-number" id="pacientesTotal">0</span>
      <span>pacientes</span>
    </div>
  </div>
</header>

<main id="main">
  <section>
    <h2>Incidente</h2>
    <input id="titulo" type="text" placeholder="Ej.: INCENDIO" 
      style="width:100%;height:44px;border-radius:12px;border:1px solid #1f2937;background:#0b1221;color:#e5e7eb;padding:10px;">
  </section>

  <section>
    <h2>Dirección</h2>
    <input id="direccion" type="text" placeholder="Ej.: SIMON GUERRERO 3131 (Villa 15 Oculta)" 
      style="width:100%;height:44px;border-radius:12px;border:1px solid #1f2937;background:#0b1221;color:#e5e7eb;padding:10px;">
  </section>

  <section>
    <h2>Sexo</h2>
    <div class="grid-2">
      <div class="counter" data-key="sexo_f">
        <span class="label">Femeninos</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
      <div class="counter" data-key="sexo_m">
        <span class="label">Masculinos</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
      <div class="counter sd-disabled" data-key="sexo_sd">
        <span class="label">S/D (automático)</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Edad</h2>
    <div class="grid-2">
      <div class="counter" data-key="edad_menores">
        <span class="label">Menores</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
      <div class="counter" data-key="edad_mayores">
        <span class="label">Mayores</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
      <div class="counter sd-disabled" data-key="edad_sd">
        <span class="label">S/D (automático)</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Procedimiento</h2>
    <div class="grid-2">
      <div class="counter" data-key="proc_atendidos">
        <span class="label">Atendidos en el lugar</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
      <div class="counter" data-key="proc_trasladados">
        <span class="label">Trasladados</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Dotación</h2>
    <div class="grid-2">
      <div class="counter" data-key="dot_moviles">
        <span class="label">Móviles</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
      <div class="counter" data-key="dot_aereo">
        <span class="label">Aéreo</span>
        <div class="controls">
          <button class="btn" data-action="-">−</button>
          <span class="value" data-value>0</span>
          <button class="btn primary" data-action="+">+</button>
        </div>
      </div>
    </div>
  </section>

  <section>
    <h2>Notas</h2>
    <textarea id="notas" placeholder="Observaciones rápidas..." style="width:100%;height:100px;border-radius:12px;border:1px solid #1f2937;background:#0b1221;color:#e5e7eb;padding:10px;"></textarea>
    <div class="muted">Las notas también se guardan localmente.</div>
  </section>

  <section class="footer">
    <button class="btn small" id="btnCopy">Copiar resumen</button>
    <span class="muted" id="lastSaved">Guardado…</span>
  </section>
</main>

<script>
(function(){
  const TOTAL_KEY = 'pacientes_total';
  const TITLE_KEY = 'titulo_text';
  const DIR_KEY = 'direccion_text';
  const NOTE_KEY = 'notas_text';

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const num = v => Math.max(0, parseInt(v,10) || 0);
  const get = k => num(localStorage.getItem(k));
  const set = (k,v) => localStorage.setItem(k, String(num(v)));

  function totalPacientes(){
    return get('proc_atendidos') + get('proc_trasladados');
  }

  function writeUI(key){
    const box = document.querySelector(`.counter[data-key="${key}"]`);
    if (!box) return;
    box.querySelector('[data-value]').textContent = get(key);
  }

  function flashSD(selector){
    const el = document.querySelector(selector);
    if (!el) return;
    el.classList.add('flash-red');
    setTimeout(()=>el.classList.remove('flash-red'), 400);
  }

  // Redistribui S/D de SEXO com base em F + M e total
  function redistributeSexo(){
    const total = totalPacientes();
    const f = get('sexo_f');
    const m = get('sexo_m');
    const sd = Math.max(total - (f + m), 0);
    set('sexo_sd', sd);
    writeUI('sexo_sd');
    flashSD('[data-key="sexo_sd"] [data-value]');
    $('#restanteSexo').textContent = sd;
  }

  // Redistribui S/D de EDAD com base em Men + May e total
  function redistributeEdad(){
    const total = totalPacientes();
    const men = get('edad_menores');
    const may = get('edad_mayores');
    const sd = Math.max(total - (men + may), 0);
    set('edad_sd', sd);
    writeUI('edad_sd');
    flashSD('[data-key="edad_sd"] [data-value]');
    $('#restanteEdad').textContent = sd;
  }

  function recalcTotal(){
    const total = totalPacientes();
    set(TOTAL_KEY, total);
    $('#pacientesTotal').textContent = total;
  }

  function updateSaved(){
    $('#lastSaved').textContent = 'Guardado: ' + new Date().toLocaleString();
  }

  function load(){
    // carregar campos texto
    $('#titulo').value = localStorage.getItem(TITLE_KEY) || '';
    $('#direccion').value = localStorage.getItem(DIR_KEY) || '';
    $('#notas').value = localStorage.getItem(NOTE_KEY) || '';

    // carregar contadores
    ['sexo_f','sexo_m','sexo_sd','edad_menores','edad_mayores','edad_sd','proc_atendidos','proc_trasladados','dot_moviles','dot_aereo']
      .forEach(writeUI);

    recalcTotal();
    // Iniciar S/D como total quando F/M ou Men/May estão zerados
    redistributeSexo();
    redistributeEdad();
    updateSaved();
  }

  // Delegação de clicks
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const box = btn.closest('.counter');
    if (!box) return;
    const key = box.dataset.key;
    const action = btn.getAttribute('data-action');
    const delta = action === '+' ? 1 : -1;

    // Bloquear edição manual direta de S/D (é automático)
    if (key === 'sexo_sd' || key === 'edad_sd') return;

    // Procedimiento e Dotación: padrão
    if (key.startsWith('proc_') || key.startsWith('dot_')){
      set(key, get(key) + delta);
      writeUI(key);
      if (key.startsWith('proc_')){
        recalcTotal();
        // Sempre que total muda, recalcular S/Ds para redistribuir
        redistributeSexo();
        redistributeEdad();
      }
      updateSaved();
      return;
    }

    // Sexo
    if (key === 'sexo_f' || key === 'sexo_m'){
      const total = totalPacientes();
      const otherKey = key === 'sexo_f' ? 'sexo_m' : 'sexo_f';
      const cur = get(key);
      const other = get(otherKey);
      let next = cur + delta;

      // Impedir negativo
      if (next < 0) next = 0;

      // Clamp pelo total: f + m <= total
      if (next + other > total){
        next = Math.max(0, total - other);
      }

      set(key, next);
      writeUI(key);
      redistributeSexo(); // ajusta S/D automaticamente
      updateSaved();
      return;
    }

    // Edad
    if (key === 'edad_menores' || key === 'edad_mayores'){
      const total = totalPacientes();
      const otherKey = key === 'edad_menores' ? 'edad_mayores' : 'edad_mayores' === key ? 'edad_menores' : 'edad_mayores';
      const cur = get(key);
      const other = get(otherKey);
      let next = cur + delta;
      if (next < 0) next = 0;
      if (next + other > total){
        next = Math.max(0, total - other);
      }
      set(key, next);
      writeUI(key);
      redistributeEdad();
      updateSaved();
      return;
    }
  });

  // Inputs texto
  $('#titulo').addEventListener('input', (e)=>{ localStorage.setItem(TITLE_KEY, e.target.value); updateSaved(); });
  $('#direccion').addEventListener('input', (e)=>{ localStorage.setItem(DIR_KEY, e.target.value); updateSaved(); });
  $('#notas').addEventListener('input', (e)=>{ localStorage.setItem(NOTE_KEY, e.target.value); updateSaved(); });

  // Reset
  $('#btnReset').addEventListener('click', () => {
    if (!confirm('¿Reiniciar todos los contadores y limpiar Incidente/Dirección/Notas?')) return;
    ['sexo_f','sexo_m','sexo_sd','edad_menores','edad_mayores','edad_sd','proc_atendidos','proc_trasladados','dot_moviles','dot_aereo']
      .forEach(k => set(k, 0));
    ['titulo_text','direccion_text','notas_text'].forEach(k => localStorage.removeItem(k));
    ['sexo_f','sexo_m','sexo_sd','edad_menores','edad_mayores','edad_sd','proc_atendidos','proc_trasladados','dot_moviles','dot_aereo']
      .forEach(writeUI);
    $('#titulo').value = ''; $('#direccion').value = ''; $('#notas').value = '';
    recalcTotal(); redistributeSexo(); redistributeEdad(); updateSaved();
    alert('Listo: se reinició todo.');
  });

  // Export JSON
  $('#btnExport').addEventListener('click', () => {
    const data = {
      incidente: localStorage.getItem(TITLE_KEY) || '',
      direccion: localStorage.getItem(DIR_KEY) || '',
      pacientes: totalPacientes(),
      sexo_f: get('sexo_f'), sexo_m: get('sexo_m'), sexo_sd: get('sexo_sd'),
      edad_menores: get('edad_menores'), edad_mayores: get('edad_mayores'), edad_sd: get('edad_sd'),
      proc_atendidos: get('proc_atendidos'), proc_trasladados: get('proc_trasladados'),
      dot_moviles: get('dot_moviles'), dot_aereo: get('dot_aereo'),
      notas: localStorage.getItem(NOTE_KEY) || ''
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'contador_mci.json'; a.click();
    URL.revokeObjectURL(url);
  });

  // Export PDF (texto simples)
  $('#btnExportPDF').addEventListener('click', () => {
    const d = k => get(k);
    const lines = [
      `Incidente: ${(localStorage.getItem(TITLE_KEY)||'').trim()}`,
      `Dirección: ${(localStorage.getItem(DIR_KEY)||'').trim()}`,
      ``,
      `Hasta ahora ${totalPacientes()} pacientes`,
      ``,
      `Sexo:`,
      `* ${d('sexo_f')} Femeninos.`,
      `* ${d('sexo_m')} Masculinos.`,
      `* ${d('sexo_sd')} S/D`,
      ``,
      `Edad:`,
      `* ${d('edad_menores')} Menores`,
      `* ${d('edad_mayores')} Mayores`,
      `* ${d('edad_sd')} S/D`,
      ``,
      `Procedimiento`,
      `* ${d('proc_atendidos')} Atendidos en el lugar:`,
      `* ${d('proc_trasladados')} trasladados`,
      ``,
      `Dotación:`,
      `* ${d('dot_moviles')} Móviles`,
      `* ${d('dot_aereo')} Aéreo`,
      ``,
      `Notas:`,
      (localStorage.getItem(NOTE_KEY)||'').trim()
    ];
    const blob = new Blob([lines.join('\n')], {type:'application/pdf'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'reporte_SAME_ECUES.pdf';
    a.click();
    URL.revokeObjectURL(a.href);
  });

  // Copiar resumen (com o formato que você mostrou)
  $('#btnCopy').addEventListener('click', () => {
    const d = k => get(k);
    const lines = [
      `Incidente: ${(localStorage.getItem(TITLE_KEY)||'').trim()}`,
      `Dirección: ${(localStorage.getItem(DIR_KEY)||'').trim()}`,
      ``,
      `Hasta ahora ${totalPacientes()} pacientes`,
      ``,
      `Sexo:`,
      `* ${d('sexo_f')} Femeninos.`,
      `* ${d('sexo_m')} Masculinos.`,
      `* ${d('sexo_sd')} S/D`,
      ``,
      `Edad:`,
      `* ${d('edad_menores')} Menores`,
      `* ${d('edad_mayores')} Mayores`,
      `* ${d('edad_sd')} S/D`,
      ``,
      `Procedimiento`,
      `* ${d('proc_atendidos')} Atendidos en el lugar:`,
      `* ${d('proc_trasladados')} trasladados`,
      ``,
      `Dotación:`,
      `* ${d('dot_moviles')} Móviles`,
      `* ${d('dot_aereo')} Aéreo`,
      ``,
      `Notas:`,
      (localStorage.getItem(NOTE_KEY)||'').trim()
    ];
    navigator.clipboard.writeText(lines.join('\n')).then(()=>alert('Resumen copiado.'));
  });

  // Init
  load();
})();
</script>
</body>
</html>
